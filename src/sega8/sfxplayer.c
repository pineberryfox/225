#include "sfxplayer.h"
#include "notes.h"

enum {
	CHN1 = 0,
	CHN2 = 0x20U,
	CHN3 = 0x40U,
};

unsigned char const sfx00[] = {
	0x01U,0x0FU,0x02U,NOTE(C ,2),0x00U,0x00U,
	0x03U,0x0EU,0x00U,NOTE(C ,1),0x00U,0x00U,
	0x03U,0x0CU,0x01U,NOTE(Cs,1),0x00U,0x00U,
	0x03U,0x0AU,0x02U,NOTE(C ,1),0x00U,0x00U,
	0x02U,0x06U,0x01U,NOTE(As,0),0x00U,0x00U,
	0xFFU,
};

unsigned char const sfx01[] = {
	0x0CU,0x0FU,0x00U,NOTE(C ,1),0x00U,0x00U,
	0x06U,0x0BU,0x00U,NOTE(C ,0),0x00U,0x00U,
	0x06U,0x0AU,0x01U,NOTE(C ,1),0x00U,0x00U,
	0x0CU,0x0FU,0x00U,NOTE(G ,1),0x00U,0x00U,
	0x0CU,0x07U,0x00U,NOTE(G ,0),0x00U,0x00U,
	0x03U,0x0FU,0x00U,NOTE(F ,1),0x00U,0x00U,
	0x03U,0x0BU,0x00U,NOTE(F ,1),0x00U,0x00U,
	0x03U,0x08U,0x01U,NOTE(F ,1),0x00U,0x00U,
	0x03U,0x07U,0x01U,NOTE(F ,1),0x00U,0x00U,
	0x06U,0x0FU,0x00U,NOTE(C ,1),0x00U,0x00U,
	0x03U,0x0BU,0x00U,NOTE(C ,2),0x00U,0x00U,
	0x03U,0x0CU,0x00U,NOTE(C ,2),0x00U,0x00U,
	0x0CU,0x0DU,0x00U,NOTE(C ,2),0x00U,0x00U,
	0xFFU,
};

unsigned char const sfx02[] = {
	0x03U,0x00U,0x00U,NOTE(C, 0),0x08U,0x02U,
	0x05U,0x02U,0x01U,NOTE(C, 1),0x0AU,0x05U,
	0x03U,0x00U,0x02U,NOTE(C, 0),0x0DU,0x04U,
	0xFFU,
};

unsigned char const sfx03[] = {
	0x03U,0x00U,0x00U,NOTE(C, 0),0x08U,0x06U,
	0xFFU,
};

static unsigned char const note_low[] = {
	0x87U, 0x87U, 0x8aU, 0x8fU, 0x87U, 0x81U,
	0x8dU, 0x8bU, 0x8bU, 0x8cU, 0x80U, 0x85U,
	0x8cU, 0x84U, 0x8dU, 0x88U, 0x83U, 0x80U,
	0x8eU, 0x8dU, 0x8dU, 0x8eU, 0x80U, 0x82U,
	0x86U, 0x8aU, 0x8eU, 0x84U, 0x8aU, 0x80U,
	0x87U, 0x8fU, 0x87U, 0x8fU, 0x88U, 0x81U,
	0x8bU, 0x85U, 0x8fU, 0x8aU, 0x85U, 0x80U,
	0x8cU, 0x87U, 0x83U, 0x80U, 0x8cU, 0x89U,
	0x85U, 0x82U, 0x80U, 0x8dU, 0x8aU, 0x88U,
	0x86U, 0x84U, 0x82U, 0x80U, 0x8eU, 0x8cU,
	0x8bU, 0x89U, 0x88U, 0x86U, 0x85U, 0x84U,
	0x83U, 0x82U, 0x81U, 0x80U, 0x8fU, 0x8eU,
};
static unsigned char const note_high[] = {
	0x35U, 0x32U, 0x2fU, 0x2cU, 0x2aU, 0x28U,
	0x25U, 0x23U, 0x21U, 0x1fU, 0x1eU, 0x1cU,
	0x1aU, 0x19U, 0x17U, 0x16U, 0x15U, 0x14U,
	0x12U, 0x11U, 0x10U, 0x0fU, 0x0fU, 0x0eU,
	0x0dU, 0x0cU, 0x0bU, 0x0bU, 0x0aU, 0x0aU,
	0x09U, 0x08U, 0x08U, 0x07U, 0x07U, 0x07U,
	0x06U, 0x06U, 0x05U, 0x05U, 0x05U, 0x05U,
	0x04U, 0x04U, 0x04U, 0x04U, 0x03U, 0x03U,
	0x03U, 0x03U, 0x03U, 0x02U, 0x02U, 0x02U,
	0x02U, 0x02U, 0x02U, 0x02U, 0x01U, 0x01U,
	0x01U, 0x01U, 0x01U, 0x01U, 0x01U, 0x01U,
	0x01U, 0x01U, 0x01U, 0x01U, 0x00U, 0x00U,
};

static unsigned char const * sfx = 0;
static unsigned char duration;
static __sfr __at 0x7F psg;

void
sfx_sound_init(void)
{
	psg = 0x9FU;
	psg = 0xBFU;
	psg = 0xDFU;
	psg = 0xFFU;
	sfx = 0;
}

void
sfx_set_sample(unsigned char bank, unsigned char const * sample)
{
	sfx = sample;
	duration = 0;
}

unsigned char
sfx_play_isr(void)
{
	unsigned char x;
	if (!sfx) return 0;
	if (duration--) return 0;
	if (sfx[0] == 0xFFU)
	{
		sfx_sound_init();
		return 0;
	}
	duration = *(sfx++);
	psg = 0x90U | ((~(*(sfx++))) & 0x0FU);
	++sfx;
	x = *(sfx++);
	psg = CHN1 | note_low[x];
	psg = note_high[x];
	psg = 0xF0U | ((~(*(sfx++))) & 0x0FU);
	psg = 0xE0U | *(sfx++);
}
